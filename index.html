<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tikklok</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2rem;
      background: #f9f9f9;
      color: #333;
      text-align: center;
    }
    button {
      margin: 1rem;
      padding: 1rem 2rem;
      font-size: 1rem;
      border: none;
      border-radius: 10px;
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
    }
    button:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 2rem;
    }
    .stats {
      margin-top: 2rem;
      font-size: 1.2rem;
    }
    .week-overview {
      text-align: left;
      max-width: 500px;
      margin: 2rem auto 0;
      font-size: 1rem;
      background: #fff;
      padding: 1rem;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <h1>ðŸ•’ Tikklok</h1>
  <button id="startBtn">Start</button>
  <button id="pauzeBtn" disabled>Pauze</button>
  <button id="stopBtn" disabled>Stop</button>
  <button id="exportBtn">Genereer PDF</button>

  <div class="stats">
    <p><strong>Vandaag:</strong> <span id="todayTime">0u 0m 0s</span></p>
    <p><strong>Pauze vandaag:</strong> <span id="pauseTime">0m 0s</span></p>
    <p><strong>Deze week:</strong> <span id="weekTime">0u 0m 0s</span></p>
  </div>

  <div class="week-overview" id="weekOverview">
    <h3>ðŸ“… Overzicht per week</h3>
    <ul id="weekList"></ul>
  </div>

  <script>
    let startTime = null;
    let totalPause = 0;
    let pauseStart = null;

    const startBtn = document.getElementById('startBtn');
    const pauzeBtn = document.getElementById('pauzeBtn');
    const stopBtn = document.getElementById('stopBtn');
    const exportBtn = document.getElementById('exportBtn');

    const todayTime = document.getElementById('todayTime');
    const pauseTime = document.getElementById('pauseTime');
    const weekTime = document.getElementById('weekTime');
    const weekList = document.getElementById('weekList');

    let storage = JSON.parse(localStorage.getItem("tikklokData") || "{}");

    function saveData() {
      localStorage.setItem("tikklokData", JSON.stringify(storage));
    }

    function format(ms) {
      const totalSecs = Math.floor(ms / 1000);
      const hrs = Math.floor(totalSecs / 3600);
      const mins = Math.floor((totalSecs % 3600) / 60);
      const secs = totalSecs % 60;
      return `${hrs}u ${mins}m ${secs}s`;
    }

    function formatMinutes(ms) {
      const totalSecs = Math.floor(ms / 1000);
      const mins = Math.floor(totalSecs / 60);
      const secs = totalSecs % 60;
      return `${mins}m ${secs}s`;
    }

    function getWeek(d) {
      d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
    }

    function updateDisplay() {
      const now = new Date();
      const todayKey = now.toISOString().slice(0,10);
      const weekKey = now.getFullYear() + "-w" + getWeek(now);

      todayTime.textContent = format(storage[todayKey] || 0);
      weekTime.textContent = format(storage[weekKey] || 0);
      pauseTime.textContent = formatMinutes(storage["pauze_" + todayKey] || 0);

      // Week overzicht
      const overzicht = {};
      for (const key in storage) {
        if (key.includes("-w")) {
          overzicht[key] = storage[key];
        }
      }
      weekList.innerHTML = "";
      Object.entries(overzicht)
        .sort(([a], [b]) => b.localeCompare(a)) // nieuwste eerst
        .forEach(([week, tijd]) => {
          const li = document.createElement("li");
          li.textContent = `${week}: ${format(tijd)} gewerkt`;
          weekList.appendChild(li);
        });
    }

    startBtn.onclick = () => {
      startTime = Date.now();
      totalPause = 0;
      pauseStart = null;
      startBtn.disabled = true;
      pauzeBtn.disabled = false;
      stopBtn.disabled = false;
    };

    pauzeBtn.onclick = () => {
      if (pauseStart) {
        const thisPause = Date.now() - pauseStart;
        totalPause += thisPause;
        pauseStart = null;
        pauzeBtn.textContent = "Pauze";

        const todayKey = new Date().toISOString().slice(0,10);
        storage["pauze_" + todayKey] = (storage["pauze_" + todayKey] || 0) + thisPause;
        saveData();
        updateDisplay();
      } else {
        pauseStart = Date.now();
        pauzeBtn.textContent = "Hervat";
      }
    };

    stopBtn.onclick = () => {
      let endTime = Date.now();
      if (pauseStart) {
        const thisPause = endTime - pauseStart;
        totalPause += thisPause;
        pauseStart = null;

        const todayKey = new Date().toISOString().slice(0,10);
        storage["pauze_" + todayKey] = (storage["pauze_" + todayKey] || 0) + thisPause;
      }

      const workTime = endTime - startTime - totalPause;
      const now = new Date();
      const todayKey = now.toISOString().slice(0,10);
      const weekKey = now.getFullYear() + "-w" + getWeek(now);

      storage[todayKey] = (storage[todayKey] || 0) + workTime;
      storage[weekKey] = (storage[weekKey] || 0) + workTime;

      saveData();
      updateDisplay();

      startBtn.disabled = false;
      pauzeBtn.disabled = true;
      stopBtn.disabled = true;
      pauzeBtn.textContent = "Pauze";
    };

    exportBtn.onclick = () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFont("helvetica", "normal");
      doc.setFontSize(16);
      doc.text("Tikklok Overzicht", 20, 20);

      let yOffset = 30;

      doc.setFontSize(12);
      doc.text("Dagelijks overzicht:", 20, yOffset);
      yOffset += 10;
      const dagen = Object.keys(storage).filter(k => k.match(/^\d{4}-\d{2}-\d{2}$/));
      dagen.sort().forEach(key => {
        const werk = format(storage[key] || 0);
        const pauze = formatMinutes(storage["pauze_" + key] || 0);
        doc.text(`${key}: ${werk} gewerkt â€“ ${pauze} pauze`, 20, yOffset);
        yOffset += 10;
      });

      yOffset += 5;
      doc.setFontSize(12);
      doc.text("Wekelijks overzicht:", 20, yOffset);
      yOffset += 10;
      const weken = Object.entries(storage).filter(([k, _]) => k.includes("-w"));
      weken.sort((a, b) => b[0].localeCompare(a[0])).forEach(([week, tijd]) => {
        doc.text(`${week}: ${format(tijd)} gewerkt`, 20, yOffset);
        yOffset += 10;
      });

      yOffset += 5;
      doc.setFontSize(14);
      doc.text("Totale werktijd:", 20, yOffset);
      yOffset += 10;
      doc.setFontSize(12);
      doc.text(`Vandaag: ${todayTime.textContent}`, 20, yOffset);
      yOffset += 10;
      doc.text(`Deze week: ${weekTime.textContent}`, 20, yOffset);

      doc.save("tikklok_overzicht.pdf");
    };

    updateDisplay();
  </script>
</body>
</html>
